---
import BaseLayout from '@/layouts/BaseLayout.astro';
import NewsCarousel from '@/components/NewsCarousel.astro';
import ResourcesGrid from '@/components/ResourcesGrid.astro';
import TabbedServices from '@/components/TabbedServices.astro';
import InsightsFeed from '@/components/InsightsFeed.astro';
import siteData from '@/data/site.json';
import { getCollection } from 'astro:content';

const testimonials = await getCollection('testimonials');
const featuredTestimonials = testimonials.filter(t => t.data.featured).slice(0, 2);

// Get blog posts to check if we should show Insights section
const blogPosts = await getCollection('blog');
const hasBlogPosts = blogPosts.length > 0;

// Get services to check if we should show Practice Areas section
const services = await getCollection('services');
const hasServices = services.length > 0;

const { hero, sections, company, news, resources, socialProof } = siteData;
const heroHeadline = hero?.headline || '';
const heroHeadlineWords = heroHeadline.trim().split(/\s+/).filter(Boolean).length;
const isLongHeroHeadline = heroHeadline.length >= 60 || heroHeadlineWords >= 9;

// Check for video background
const hasVideo = hero?.backgroundVideo;
const hasImage = hero?.backgroundImage;

// Get practice areas from services for the hero card (if available)
const topServices = services.slice(0, 3);
---

<BaseLayout lightHero={!hasVideo && !hasImage}>
  <!-- Hero Section - Cooley-inspired cinematic design -->
  <section class="relative min-h-screen bg-charcoal-950 overflow-hidden">
    <!-- Video/Image Background -->
    {hasVideo ? (
      <div class="absolute inset-0">
        <video 
          id="hero-video"
          class="w-full h-full object-cover"
          autoplay 
          muted 
          loop 
          playsinline
          poster={hasImage || ''}
        >
          <source src={hero.backgroundVideo} type="video/mp4" />
        </video>
        <!-- Gradient overlay for text readability -->
        <div class="absolute inset-0 bg-gradient-to-r from-charcoal-950/90 via-charcoal-950/70 to-charcoal-950/50"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-charcoal-950/80 via-transparent to-charcoal-950/30"></div>
      </div>
    ) : hasImage ? (
      <div class="absolute inset-0">
        <img 
          src={hero.backgroundImage} 
          alt=""
          class="w-full h-full object-cover"
        />
        <!-- Gradient overlay for text readability -->
        <div class="absolute inset-0 bg-gradient-to-r from-charcoal-950/90 via-charcoal-950/70 to-charcoal-950/40"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-charcoal-950/70 via-transparent to-charcoal-950/20"></div>
      </div>
    ) : (
      <!-- No media - light theme with subtle gradient -->
      <div class="absolute inset-0 bg-gradient-to-br from-white via-neutral-50 to-white"></div>
    )}
    
    <!-- Subtle noise texture for premium feel -->
    <div class="absolute inset-0 opacity-[0.015] mix-blend-overlay" style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noise%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.9%22 numOctaves=%224%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noise)%22/%3E%3C/svg%3E');"></div>
    
    <!-- Video Control Button (Cooley-style) -->
    {hasVideo && (
      <button 
        id="video-toggle"
        class="absolute top-28 right-6 lg:right-8 z-20 flex items-center gap-2 px-4 py-2 bg-white/10 backdrop-blur-sm border border-white/20 text-white/80 text-sm font-medium hover:bg-white/20 transition-all group"
        aria-label="Pause video"
      >
        <span class="w-2 h-2 rounded-full bg-primary-500 animate-pulse group-hover:animate-none"></span>
        <span id="video-toggle-text">Pause video</span>
      </button>
    )}
    
    <!-- Hero Content -->
    <div class="relative z-10 min-h-screen flex items-center">
      <div class="max-w-7xl mx-auto px-6 lg:px-8 py-32 lg:py-40 w-full">
        <div class="grid lg:grid-cols-12 gap-12 lg:gap-16 items-center">
          <!-- Main Content - Takes 7 columns -->
          <div class="lg:col-span-7" data-reveal-stagger>
            <!-- Tagline with red accent -->
            <div class="inline-flex items-center gap-3 text-xs uppercase tracking-[0.3em] {hasVideo || hasImage ? 'text-white/60' : 'text-neutral-500'}">
              <span class="h-[2px] w-10 bg-primary-500"></span>
              <span>{company.tagline || `${company.address?.city ? company.address.city + ', ' : ''}${company.address?.state || ''} Attorneys`}</span>
            </div>
            
            <!-- Main Headline - Dramatic Cooley-style typography -->
            <h1
              class:list={[
                "mt-6 lg:mt-8 font-display tracking-[-0.04em] leading-[0.9]",
                hasVideo || hasImage ? "text-white" : "text-charcoal-950",
                isLongHeroHeadline
                  ? "text-4xl sm:text-5xl md:text-6xl lg:text-7xl"
                  : "text-5xl sm:text-6xl md:text-7xl lg:text-8xl xl:text-[7rem]"
              ]}
            >
              {hero.headline}
            </h1>
            
            <!-- Subheadline -->
            {(hero.subheadline || company.description) && (
              <p class:list={[
                "mt-6 lg:mt-8 text-lg sm:text-xl max-w-2xl leading-relaxed",
                hasVideo || hasImage ? "text-white/70" : "text-neutral-600"
              ]}>
                {hero.subheadline || company.description}
              </p>
            )}
            
            <!-- CTA Buttons -->
            <div class="mt-8 lg:mt-10 flex flex-wrap items-center gap-4">
              <a 
                href={hero.cta?.href || "/contact"}
                class="group inline-flex items-center gap-3 px-8 py-4 bg-primary-500 text-white font-semibold tracking-tight hover:bg-primary-600 transition-all duration-300 hover:gap-4 hover:shadow-glow-red"
              >
                {hero.cta?.label || "Contact Us"}
                <svg class="w-4 h-4 transition-transform duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </a>
              {company.phone && (
                <a 
                  href={`tel:${company.phone.replace(/[^\\d+]/g, '')}`}
                  class:list={[
                    "inline-flex items-center gap-2 px-8 py-4 border-2 font-semibold tracking-tight transition-all duration-300",
                    hasVideo || hasImage 
                      ? "border-white/30 text-white hover:border-white/60 hover:bg-white/10" 
                      : "border-charcoal-200 text-charcoal-800 hover:border-charcoal-400 hover:bg-charcoal-50"
                  ]}
                >
                  {company.phone}
                </a>
              )}
            </div>
          </div>
          
          <!-- Practice Focus Card - Takes 5 columns -->
          <div class="lg:col-span-5" data-reveal="right">
            <div class="bg-charcoal-900/95 backdrop-blur-sm p-8 lg:p-10 relative overflow-hidden border border-white/5 shadow-2xl">
              <!-- Decorative elements -->
              <div class="absolute top-0 right-0 w-32 h-32 bg-primary-500/10"></div>
              <div class="absolute top-0 right-0 w-1 h-full bg-primary-500"></div>
              <div class="absolute bottom-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-primary-500/30 to-transparent"></div>
              
              <div class="relative">
                <div class="text-xs uppercase tracking-[0.3em] text-neutral-400 mb-6 font-medium">Practice Focus</div>
                
                <!-- Dynamic practice areas from services -->
                <div class="space-y-4">
                  {topServices.length > 0 ? (
                    topServices.map((service) => (
                      <a href={`/services/${service.slug}`} class="group flex items-center gap-4 text-white/90 hover:text-white transition-all duration-300">
                        <span class="w-2 h-2 rounded-full bg-primary-500 group-hover:scale-150 group-hover:shadow-glow transition-all duration-300"></span>
                        <span class="text-lg font-display">{service.data.title}</span>
                        <svg class="w-4 h-4 ml-auto opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                      </a>
                    ))
                  ) : (
                    <>
                      <div class="flex items-center gap-4 text-white/90">
                        <span class="w-2 h-2 rounded-full bg-primary-500"></span>
                        <span class="text-lg font-display">Estate Planning</span>
                      </div>
                      <div class="flex items-center gap-4 text-white/90">
                        <span class="w-2 h-2 rounded-full bg-primary-500"></span>
                        <span class="text-lg font-display">Elder Law & Medicaid</span>
                      </div>
                      <div class="flex items-center gap-4 text-white/90">
                        <span class="w-2 h-2 rounded-full bg-primary-500"></span>
                        <span class="text-lg font-display">Probate & Trust Administration</span>
                      </div>
                    </>
                  )}
                </div>
                
                <!-- Location with icon -->
                {company.address && (
                  <div class="mt-8 pt-6 border-t border-white/10 flex items-center gap-3">
                    <svg class="w-4 h-4 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-sm text-neutral-400">
                      {company.address?.city ? `${company.address.city}, ${company.address.state}` : company.address?.state}
                    </span>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Scroll Indicator - Bottom center -->
    <div class="absolute bottom-8 left-1/2 -translate-x-1/2 z-10 flex flex-col items-center gap-3 {hasVideo || hasImage ? 'text-white/50' : 'text-neutral-400'}" data-reveal="up">
      <span class="text-xs uppercase tracking-[0.3em]">Scroll</span>
      <div class="w-px h-12 bg-gradient-to-b from-current to-transparent animate-pulse"></div>
    </div>
  </section>

  <!-- News Carousel -->
  {news && news.length > 0 && (
    <NewsCarousel items={news} />
  )}

  <!-- Resources Grid -->
  {resources && resources.length > 0 && (
    <>
      <div class="section-divider"></div>
      <ResourcesGrid 
        headline="Resources" 
        resources={resources} 
      />
    </>
  )}

  <!-- About Section - Cooley-style asymmetric split -->
  {sections.about?.content && (
    <section class="relative overflow-hidden">
      <div class="grid lg:grid-cols-2">
        <!-- Left Visual Side - Red accent block -->
        <div class="min-h-[400px] lg:min-h-[600px] relative bg-charcoal-900" data-image-reveal>
          <!-- Background image if available -->
          {sections.about.image ? (
            <img 
              src={sections.about.image} 
              alt="" 
              class="absolute inset-0 w-full h-full object-cover opacity-60"
            />
          ) : (
            <>
              <!-- Decorative ampersand -->
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-white/5 font-display text-[16rem] lg:text-[22rem] font-bold leading-none select-none">
                  &
                </div>
              </div>
              <!-- Floating accent shapes -->
              <div class="absolute top-12 left-12 w-20 h-20 border-2 border-primary-500/30 rotate-12"></div>
              <div class="absolute bottom-16 right-16 w-12 h-12 bg-primary-500/20 rounded-full"></div>
            </>
          )}
          <!-- Red corner accent -->
          <div class="absolute top-0 right-0 w-24 h-24 bg-primary-500"></div>
        </div>
        
        <!-- Right Content Side -->
        <div class="py-16 lg:py-24 px-8 lg:px-16 flex items-center bg-white">
          <div class="max-w-xl" data-reveal>
            <div class="inline-flex items-center gap-3 text-xs uppercase tracking-[0.25em] text-neutral-500 mb-6">
              <span class="h-[3px] w-8 bg-primary-500"></span>
              <span>About Our Firm</span>
            </div>
            
            <h2 class="font-display text-3xl md:text-4xl lg:text-5xl text-charcoal-950 tracking-[-0.02em] mb-6">
              {sections.about.headline}
            </h2>
            
            <p class="text-lg text-neutral-600 leading-relaxed mb-8">
              {sections.about.content}
            </p>
            
            <!-- Values/USPs (only if available) -->
            {sections.about.values && sections.about.values.length > 0 && (
              <div class="space-y-4 mb-8 pt-6 border-t border-neutral-200" data-reveal-stagger>
                {sections.about.values.slice(0, 3).map((value) => (
                  <div class="flex gap-4 group">
                    <div class="w-1 bg-primary-500/30 group-hover:bg-primary-500 flex-shrink-0 transition-colors"></div>
                    <div>
                      <h3 class="font-semibold text-charcoal-900">{value.title}</h3>
                      <p class="text-sm text-neutral-500 mt-0.5">{value.description}</p>
                    </div>
                  </div>
                ))}
              </div>
            )}
            
            <a href="/about" class="inline-flex items-center gap-2 text-primary-500 font-semibold hover:gap-3 transition-all">
              Learn more about us
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Latest Insights (only show if there are blog posts) -->
  {hasBlogPosts && (
    <InsightsFeed headline={sections.insights?.headline || "Latest insights"} limit={5} />
  )}

  <!-- Tabbed Services Section (only show if there are services) -->
  {hasServices && (
    <TabbedServices 
      headline={sections.services?.headline}
      practicesHeadline={sections.services?.practicesHeadline}
      industriesHeadline={sections.services?.industriesHeadline}
    />
  )}

  <!-- Stats Section -->
  {socialProof?.stats && socialProof.stats.length > 0 && (
    <section class="py-20 lg:py-28 bg-white border-y border-neutral-200 relative overflow-hidden">
      <!-- Subtle background decoration -->
      <div class="absolute inset-0 opacity-5">
        <div class="absolute top-0 left-1/4 w-80 h-80 bg-primary-500 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-0 right-1/4 w-64 h-64 bg-primary-500 rounded-full blur-[100px]"></div>
      </div>
      <div class="max-w-7xl mx-auto px-6 lg:px-8 relative z-10">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-8 md:gap-12" data-reveal-stagger>
          {socialProof.stats.map((stat) => (
            <div class="text-center group">
              <p class="font-display text-4xl md:text-5xl lg:text-6xl text-primary-500 tracking-[-0.02em] group-hover:scale-105 transition-transform">
                {stat.value}
              </p>
              <p class="mt-3 text-sm uppercase tracking-[0.2em] text-neutral-500">
                {stat.label}
              </p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Testimonials -->
  {featuredTestimonials.length > 0 && (
    <section class="bg-neutral-50 py-20 lg:py-28">
      <div class="max-w-7xl mx-auto px-6 lg:px-8">
        <div class="mb-12 lg:mb-16" data-reveal>
          <div class="inline-flex items-center gap-3 text-xs uppercase tracking-[0.25em] text-neutral-500 mb-4">
            <span class="h-[3px] w-8 bg-primary-500"></span>
            <span>Client Stories</span>
          </div>
          <h2 class="font-display text-4xl md:text-5xl lg:text-6xl text-charcoal-950 tracking-[-0.02em]">
            {sections.testimonials?.headline || "What our clients say"}
          </h2>
        </div>
        
        <div class="grid md:grid-cols-2 gap-6 lg:gap-8" data-reveal-stagger>
          {featuredTestimonials.map((testimonial) => (
            <div class="bg-white p-8 lg:p-10 border border-neutral-200 hover:border-primary-200 hover:shadow-lg transition-all" data-card>
              <!-- Quote icon -->
              <svg class="w-8 h-8 text-primary-500/40 mb-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
              </svg>
              
              <blockquote class="text-lg md:text-xl text-charcoal-800 leading-relaxed mb-6 font-display">
                "{testimonial.data.quote || testimonial.body}"
              </blockquote>
              
              <div class="flex items-center gap-3 pt-4 border-t border-neutral-100">
                <div class="w-10 h-10 bg-primary-500/10 rounded-full flex items-center justify-center">
                  <span class="text-primary-600 font-bold">
                    {testimonial.data.author?.charAt(0) || "?"}
                  </span>
                </div>
                <div>
                  <p class="font-semibold text-charcoal-900">{testimonial.data.author}</p>
                  {(testimonial.data.role || testimonial.data.company) && (
                    <p class="text-sm text-neutral-500">
                      {[testimonial.data.role, testimonial.data.company].filter(Boolean).join(' Â· ')}
                    </p>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- CTA Section -->
  {sections.cta && (
    <section class="bg-primary-500 py-20 lg:py-28 relative overflow-hidden">
      <!-- Decorative elements -->
      <div class="absolute -top-20 -right-20 w-64 h-64 bg-white/5 rounded-full blur-3xl"></div>
      <div class="absolute -bottom-20 -left-20 w-48 h-48 bg-white/5 rounded-full blur-3xl"></div>
      
      <div class="max-w-4xl mx-auto px-6 lg:px-8 text-center relative z-10" data-reveal="scale">
        <h2 class="font-display text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-white tracking-[-0.02em]">
          {sections.cta.headline}
        </h2>
        {sections.cta.description && (
          <p class="mt-6 text-lg md:text-xl text-white/80 max-w-2xl mx-auto leading-relaxed">
            {sections.cta.description}
          </p>
        )}
        <div class="mt-10 flex flex-wrap justify-center gap-4">
          <a 
            href={sections.cta.cta.href}
            class="group inline-flex items-center gap-3 px-8 py-4 bg-white text-charcoal-900 font-semibold hover:bg-neutral-100 transition-all"
          >
            {sections.cta.cta.label}
            <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
          {sections.cta.secondaryCta && (
            <a 
              href={sections.cta.secondaryCta.href}
              class="inline-flex items-center gap-3 px-8 py-4 border-2 border-white text-white font-semibold hover:bg-white/10 transition-all"
            >
              {sections.cta.secondaryCta.label}
            </a>
          )}
        </div>
      </div>
    </section>
  )}
</BaseLayout>

<script>
  // Video toggle functionality - Cooley-style
  const videoToggle = document.getElementById('video-toggle');
  const videoToggleText = document.getElementById('video-toggle-text');
  const heroVideo = document.getElementById('hero-video') as HTMLVideoElement;
  
  if (videoToggle && heroVideo && videoToggleText) {
    videoToggle.addEventListener('click', () => {
      if (heroVideo.paused) {
        heroVideo.play();
        videoToggleText.textContent = 'Pause video';
      } else {
        heroVideo.pause();
        videoToggleText.textContent = 'Play video';
      }
    });
  }
  
  // Scroll reveal animations
  const observerOptions = {
    root: null,
    rootMargin: '0px',
    threshold: 0.1
  };
  
  const revealObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('revealed');
        revealObserver.unobserve(entry.target);
      }
    });
  }, observerOptions);
  
  // Observe all reveal elements
  document.querySelectorAll('[data-reveal], [data-reveal-stagger], [data-card], [data-image-reveal]').forEach(el => {
    revealObserver.observe(el);
  });
</script>
